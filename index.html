<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socratic AI</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="icon" href="https://i.imgs.ovh/2025/08/04/YAAhA.png" type="image/x-icon">
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        neutral: '#F3F4F6',
                        danger: '#EF4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .message-appear {
                animation: fadeIn 0.3s ease-out forwards;
            }
            .form-appear {
                animation: slideUp 0.4s ease-out forwards;
            }
            .modal-fade {
                animation: modalFade 0.3s ease-out forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes slideUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes modalFade {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 4px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: rgba(156, 163, 175, 0.5);
                border-radius: 2px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <!-- 顶部导航的AI图标 -->
                <div class="w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                    <img src="https://i.imgs.ovh/2025/08/04/YAAhA.png" alt="Socratic AI助手" class="w-full h-full object-contain">
                </div>
                <h1 class="text-xl font-bold">Socratic AI</h1>
            </div>
            <div id="user-status" class="text-sm text-gray-500 flex items-center space-x-4">
                <span id="login-status">Please login</span>
                <button id="admin-button" class="hidden text-primary hover:underline" onclick="showAdminPanel()">Admin</button>
                <button id="logout-button" class="hidden text-primary hover:underline" onclick="logout()">Log out</button>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 登录表单 -->
        <div id="login-form-container" class="max-w-md mx-auto form-appear">
            <div class="bg-white rounded-xl shadow-md p-8">
                <h2 class="text-2xl font-bold mb-6 text-center">User login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">User name</label>
                        <input 
                            type="text" 
                            id="username" 
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all"
                            placeholder="请输入用户名"
                            required
                        >
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input 
                            type="password" 
                            id="password" 
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all"
                            placeholder="请输入密码"
                            required
                        >
                    </div>
                    <div class="text-red-500 text-sm hidden" id="login-error"></div>
                    <button 
                        type="submit" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all flex items-center justify-center space-x-2 shadow hover:shadow-md"
                    >
                        <span>Login</span>
                        <i class="fa fa-sign-in"></i>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 对话区域 (默认隐藏) -->
        <div id="chat-container" class="max-w-4xl mx-auto bg-white rounded-xl shadow-md h-[calc(100vh-180px)] flex flex-col hidden">
            <!-- 对话历史 -->
            <div id="chat-history" class="flex-grow p-6 overflow-y-auto scrollbar-thin space-y-6">
                <!-- 欢迎消息 -->
                <div class="flex items-start space-x-4 message-appear">
                    <!-- AI头像 -->
                    <div class="flex-shrink-0 w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                        <img src="https://i.imgs.ovh/2025/08/04/YAAhA.png" alt="Socratic AI助手" class="w-full h-full object-contain">
                    </div>
                    <div class="max-w-[80%] bg-neutral rounded-2xl rounded-tl-none p-4">
                        <p>你好！我是苏格拉底式学习助手。我会通过提问帮助你思考学习中遇到的问题，而不是直接给你答案。</p>
                        <p class="mt-2">请提出你在学习中遇到的问题吧。</p>
                    </div>
                </div>
            </div>
            
            <!-- 输入区域 -->
            <div class="border-t border-gray-200 p-4">
                <form id="chat-form" class="flex flex-col space-y-3">
                    <textarea 
                        id="user-input" 
                        rows="3" 
                        placeholder="请输入你的问题..." 
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all resize-none"
                    ></textarea>
                    <button 
                        type="submit" 
                        class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all flex items-center justify-center space-x-2 shadow hover:shadow-md"
                        id="send-button"
                    >
                        <span>Send</span>
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- 管理员面板模态框 -->
    <div id="admin-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden modal-fade">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold">Admin dashboard</h3>
                <button onclick="closeAdminPanel()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="mb-8">
                    <h4 class="text-lg font-semibold mb-4">Add new user</h4>
                    <form id="add-user-form" class="space-y-4">
                        <div>
                            <label for="new-username" class="block text-sm font-medium text-gray-700 mb-1">User Name</label>
                            <input 
                                type="text" 
                                id="new-username" 
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all"
                                placeholder="新用户名"
                                required
                            >
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input 
                                type="password" 
                                id="new-password" 
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all"
                                placeholder="新密码"
                                required
                            >
                        </div>
                        <div class="text-green-500 text-sm hidden" id="add-user-success"></div>
                        <div class="text-red-500 text-sm hidden" id="add-user-error"></div>
                        <button 
                            type="submit" 
                            class="bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-all"
                        >
                            <i class="fa fa-plus mr-1"></i> Add User
                        </button>
                    </form>
                </div>
                
                <div class="mb-8">
                    <h4 class="text-lg font-semibold mb-4">Check user history</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="select-user" class="block text-sm font-medium text-gray-700 mb-1">Choose user</label>
                            <select id="select-user" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all">
                                <option value="">-- Choose user --</option>
                                <!-- 用户选项将通过JS动态生成 -->
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button 
                                id="clear-conversation-btn" 
                                class="bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all hidden"
                                onclick="clearUserConversation()"
                            >
                                <i class="fa fa-trash mr-1"></i> Clear History
                            </button>
                        </div>
                        <div id="conversation-history-viewer" class="border border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto scrollbar-thin hidden">
                            <!-- 对话历史将在这里显示 -->
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">用户管理</h4>
                    <div id="user-list" class="space-y-3 max-h-60 overflow-y-auto scrollbar-thin pr-2">
                        <!-- 用户列表将通过JS动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-3">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            苏格拉底式学习助手 &copy; 2023
        </div>
    </footer>

    <script>
        // 初始化用户数据 - 实际应用中应从后端获取
        let users = {
            // 管理员账户
            'admin': { password: 'admin123', isAdmin: true },
            // 默认用户
            'user1': { password: 'user1pass', isAdmin: false }
        };
        
        // 存储用户对话历史
        let userConversations = {};
        
        // 检查本地存储中的用户数据
        if (localStorage.getItem('appUsers')) {
            try {
                users = JSON.parse(localStorage.getItem('appUsers'));
            } catch (e) {
                console.error('Failed to parse users from localStorage', e);
            }
        }
        
        // 检查本地存储中的对话历史
        if (localStorage.getItem('userConversations')) {
            try {
                userConversations = JSON.parse(localStorage.getItem('userConversations'));
            } catch (e) {
                console.error('Failed to parse conversations from localStorage', e);
            }
        }
        
        // 当前登录状态
        let currentUser = null;
        let isLoggedIn = false;
        let isAdmin = false;
        
        // API配置
        const API_CONFIG = {
            endpoint: "https://api.deepseek.com/v1/chat/completions",
            apiKey: "sk-cca7729a0fc1466d9c2da405feda60d3",  // 替换为你的Deepseek API密钥
            model: "deepseek-chat"
        };
        
        // 固定的系统提示
        const SYSTEM_PROMPT = "你只能以苏格拉底式提问法回答学习的问题,绝对不能直接给答案。一次给出一步的问题，不要太多问题。一定要用发问语言回答。";
        
        // 存储当前用户的对话历史
        let conversationHistory = [
            {
                role: "system",
                content: SYSTEM_PROMPT
            }
        ];
        
        // DOM元素
        const loginForm = document.getElementById('login-form');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const sendButton = document.getElementById('send-button');
        const loginFormContainer = document.getElementById('login-form-container');
        const chatContainer = document.getElementById('chat-container');
        const loginStatus = document.getElementById('login-status');
        const logoutButton = document.getElementById('logout-button');
        const adminButton = document.getElementById('admin-button');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const adminModal = document.getElementById('admin-modal');
        const addUserForm = document.getElementById('add-user-form');
        const userList = document.getElementById('user-list');
        const addUserSuccess = document.getElementById('add-user-success');
        const addUserError = document.getElementById('add-user-error');
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 检查本地存储中的登录状态
            checkLoginStatus();
            
            // 登录表单提交事件
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin();
            });
            
            // 聊天表单提交事件
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (isLoggedIn) {
                    await sendMessage();
                }
            });
            
            // 添加用户表单提交事件
            addUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNewUser();
            });
            
            // 支持按Enter发送消息，Shift+Enter换行
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && isLoggedIn) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
        
        // 保存用户数据到本地存储
        function saveUsers() {
            localStorage.setItem('appUsers', JSON.stringify(users));
        }
        
        // 保存对话历史到本地存储
        function saveConversations() {
            localStorage.setItem('userConversations', JSON.stringify(userConversations));
        }
        
        // 检查登录状态
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('loggedInUser');
            if (savedUser && users[savedUser]) {
                currentUser = savedUser;
                isLoggedIn = true;
                isAdmin = users[savedUser].isAdmin;
                
                // 初始化用户对话历史（如果不存在）
                if (!userConversations[currentUser]) {
                    userConversations[currentUser] = [
                        {
                            role: "system",
                            content: SYSTEM_PROMPT
                        }
                    ];
                }
                conversationHistory = userConversations[currentUser];
                
                showChatInterface();
                loginStatus.textContent = `欢迎，${currentUser} ${isAdmin ? '(管理员)' : ''}`;
                logoutButton.classList.remove('hidden');
                
                // 如果是管理员，显示管理员按钮
                if (isAdmin) {
                    adminButton.classList.remove('hidden');
                    renderUserList();
                }
            } else {
                isLoggedIn = false;
                isAdmin = false;
                currentUser = null;
                showLoginInterface();
            }
        }
        
        // 处理登录
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            // 验证用户
            if (users[username] && users[username].password === password) {
                // 存储登录状态到本地存储
                localStorage.setItem('loggedInUser', username);
                currentUser = username;
                isLoggedIn = true;
                isAdmin = users[username].isAdmin;
                
                // 初始化用户对话历史（如果不存在）
                if (!userConversations[currentUser]) {
                    userConversations[currentUser] = [
                        {
                            role: "system",
                            content: SYSTEM_PROMPT
                        }
                    ];
                }
                conversationHistory = userConversations[currentUser];
                
                showChatInterface();
                loginStatus.textContent = `欢迎，${username} ${isAdmin ? '(管理员)' : ''}`;
                logoutButton.classList.remove('hidden');
                
                // 如果是管理员，显示管理员按钮
                if (isAdmin) {
                    adminButton.classList.remove('hidden');
                    renderUserList();
                }
                
                loginError.classList.add('hidden');
            } else {
                loginError.textContent = '用户名或密码错误，请重试';
                loginError.classList.remove('hidden');
            }
        }
        
        // 退出登录
        function logout() {
            // 保存当前用户的对话历史
            if (currentUser) {
                userConversations[currentUser] = conversationHistory;
                saveConversations();
            }
            
            localStorage.removeItem('loggedInUser');
            currentUser = null;
            isLoggedIn = false;
            isAdmin = false;
            
            showLoginInterface();
            loginStatus.textContent = '请登录';
            logoutButton.classList.add('hidden');
            adminButton.classList.add('hidden');
            
            // 重置对话历史
            conversationHistory = [
                {
                    role: "system",
                    content: SYSTEM_PROMPT
                }
            ];
            
            chatHistory.innerHTML = `
                <div class="flex items-start space-x-4 message-appear">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                        <img src="https://i.imgs.ovh/2025/08/04/YAAhA.png" alt="Socratic AI助手" class="w-full h-full object-contain">
                    </div>
                    <div class="max-w-[80%] bg-neutral rounded-2xl rounded-tl-none p-4">
                        <p>你好！我是苏格拉底式学习助手。我会通过提问帮助你思考学习中遇到的问题，而不是直接给你答案。</p>
                        <p class="mt-2">请提出你在学习中遇到的问题吧。</p>
                    </div>
                </div>
            `;
        }
        
        // 显示管理员面板
        function showAdminPanel() {
            if (isAdmin) {
                adminModal.classList.remove('hidden');
                renderUserList();
            }
        }
        
        // 关闭管理员面板
        function closeAdminPanel() {
            adminModal.classList.add('hidden');
        }
        
        // 渲染用户列表和下拉框
        function renderUserList() {
            userList.innerHTML = '';
            const userSelect = document.getElementById('select-user');
            
            // 保存当前选中的值
            const currentValue = userSelect.value;
            
            // 清空下拉框，保留第一个提示选项
            while (userSelect.options.length > 1) {
                userSelect.remove(1);
            }
            
            for (const username in users) {
                const user = users[username];
                const userItem = document.createElement('div');
                userItem.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                
                // 管理员不能删除自己
                const canDelete = !(username === currentUser && user.isAdmin);
                
                userItem.innerHTML = `
                    <div>
                        <span class="font-medium">${username}</span>
                        ${user.isAdmin ? '<span class="ml-2 text-xs bg-primary/20 text-primary px-2 py-0.5 rounded">管理员</span>' : ''}
                    </div>
                    <button 
                        onclick="deleteUser('${username}')" 
                        class="text-danger hover:text-danger/80 ${!canDelete ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${!canDelete ? 'disabled' : ''}
                    >
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                
                userList.appendChild(userItem);
                
                // 添加到下拉框（跳过当前管理员）
                if (!(username === currentUser && user.isAdmin)) {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = username;
                    userSelect.appendChild(option);
                }
            }
            
            // 恢复选中状态
            if (currentValue && userSelect.querySelector(`option[value="${currentValue}"]`)) {
                userSelect.value = currentValue;
                viewUserConversation(); // 重新显示选中用户的对话
            } else {
                // 隐藏清空按钮和对话查看器
                document.getElementById('clear-conversation-btn').classList.add('hidden');
                document.getElementById('conversation-history-viewer').classList.add('hidden');
            }
            
            // 添加事件监听器
            userSelect.onchange = viewUserConversation;
        }
        
        // 查看用户对话历史
        function viewUserConversation() {
            const username = document.getElementById('select-user').value;
            const viewer = document.getElementById('conversation-history-viewer');
            const clearBtn = document.getElementById('clear-conversation-btn');
            
            if (!username) {
                viewer.classList.add('hidden');
                clearBtn.classList.add('hidden');
                viewer.innerHTML = '';
                return;
            }
            
            // 获取该用户的对话历史
            const conversations = userConversations[username] || [];
            
            // 过滤掉系统提示
            const messages = conversations.filter(msg => msg.role !== 'system');
            
            if (messages.length === 0) {
                viewer.innerHTML = '<p class="text-gray-500 text-center py-4">该用户暂无对话历史</p>';
                viewer.classList.remove('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            // 构建对话历史HTML
            let html = '';
            messages.forEach(msg => {
                if (msg.role === 'user') {
                    html += `
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-secondary flex items-center justify-center">
                                <i class="fa fa-user text-white text-sm"></i>
                            </div>
                            <div class="max-w-[80%] ml-auto bg-primary text-white rounded-2xl rounded-tr-none p-3">
                                <p class="text-sm">${msg.content}</p>
                            </div>
                        </div>
                    `;
                } else if (msg.role === 'assistant') {
                    html += `
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden bg-white p-0.5">
                                <img src="https://i.imgs.ovh/2025/08/04/YAAhA.png" alt="Socratic AI助手" class="w-full h-full object-contain">
                            </div>
                            <div class="max-w-[80%] bg-neutral rounded-2xl rounded-tl-none p-3">
                                <p class="text-sm">${msg.content}</p>
                            </div>
                        </div>
                    `;
                }
            });
            
            viewer.innerHTML = html;
            viewer.classList.remove('hidden');
            clearBtn.classList.remove('hidden');
        }
        
        // 清空用户对话记录
        function clearUserConversation() {
            const username = document.getElementById('select-user').value;
            if (!username || !confirm(`确定要清空用户 ${username} 的所有对话记录吗？`)) {
                return;
            }
            
            // 重置用户对话历史，只保留系统提示
            userConversations[username] = [
                {
                    role: "system",
                    content: SYSTEM_PROMPT
                }
            ];
            
            // 如果当前查看的是自己的对话，同步更新
            if (username === currentUser) {
                conversationHistory = userConversations[username];
                chatHistory.innerHTML = `
                    <div class="flex items-start space-x-4 message-appear">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                            <img src="https://i.imgs.ovh/2025/08/04/YAAhA.png" alt="Socratic AI助手" class="w-full h-full object-contain">
                        </div>
                        <div class="max-w-[80%] bg-neutral rounded-2xl rounded-tl-none p-4">
                            <p>你好！我是苏格拉底式学习助手。我会通过提问帮助你思考学习中遇到的问题，而不是直接给你答案。</p>
                            <p class="mt-2">请提出你在学习中遇到的问题吧。</p>
                        </div>
                    </div>
                `;
            }
            
            saveConversations();
            viewUserConversation(); // 刷新显示
        }
        
        // 添加新用户
        function addNewUser() {
            const newUsername = document.getElementById('new-username').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            
            if (!newUsername || !newPassword) {
                addUserError.textContent = '用户名和密码不能为空';
                addUserError.classList.remove('hidden');
                addUserSuccess.classList.add('hidden');
                return;
            }
            
            if (users[newUsername]) {
                addUserError.textContent = '用户名已存在';
                addUserError.classList.remove('hidden');
                addUserSuccess.classList.add('hidden');
                return;
            }
            
            // 添加新用户
            users[newUsername] = {
                password: newPassword,
                isAdmin: false // 默认为普通用户
            };
            
            // 初始化新用户的对话历史
            userConversations[newUsername] = [
                {
                    role: "system",
                    content: SYSTEM_PROMPT
                }
            ];
            
            // 保存用户数据和对话历史
            saveUsers();
            saveConversations();
            
            // 更新用户列表
            renderUserList();
            
            // 显示成功消息
            addUserSuccess.textContent = '用户添加成功';
            addUserSuccess.classList.remove('hidden');
            addUserError.classList.add('hidden');
            
            // 清空表单
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            
            // 3秒后隐藏成功消息
            setTimeout(() => {
                addUserSuccess.classList.add('hidden');
            }, 3000);
        }
        
        // 删除用户
        function deleteUser(username) {
            if (!confirm(`确定要删除用户 ${username} 及其所有对话历史吗？`)) {
                return;
            }
            
            // 不能删除管理员自己
            if (username === currentUser && users[username].isAdmin) {
                return;
            }
            
            // 删除用户
            delete users[username];
            
            // 删除对话历史
            delete userConversations[username];
            
            // 保存用户数据和对话历史
            saveUsers();
            saveConversations();
            
            // 更新用户列表和下拉框
            renderUserList();
        }
        
        // 显示登录界面
        function showLoginInterface() {
            loginFormContainer.classList.remove('hidden');
            chatContainer.classList.add('hidden');
            usernameInput.focus();
        }
        
        // 显示聊天界面
        function showChatInterface() {
            loginFormContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            userInput.focus();
        }
        
        // 发送消息处理函数
        async function sendMessage() {
            const userMessage = userInput.value.trim();
            
            if (!userMessage) return;
            
            // 检查API密钥是否已配置
            if (API_CONFIG.apiKey === "your_api_key_here") {
                addMessageToUI('system', '⚠️ 请先在代码中配置你的Deepseek API密钥。');
                return;
            }
            
            // 禁用发送按钮防止重复提交
            sendButton.disabled = true;
            sendButton.innerHTML = '<span>发送中...</span><i class="fa fa-spinner fa-spin ml-2"></i>';
            
            try {
                // 添加用户消息到界面
                addMessageToUI('user', userMessage);
                
                // 清空输入框
                userInput.value = '';
                
                // 添加用户消息到对话历史
                conversationHistory.push({
                    role: "user",
                    content: userMessage
                });
                
                // 保存到用户对话历史
                userConversations[currentUser] = conversationHistory;
                saveConversations();
                
                // 获取AI响应
                await getAIResponse();
            } catch (error) {
                addMessageToUI('system', `发生错误：${error.message}`);
                console.error('错误:', error);
            } finally {
                // 恢复发送按钮状态
                sendButton.disabled = false;
                sendButton.innerHTML = '<span>发送消息</span><i class="fa fa-paper-plane ml-2"></i>';
            }
        }
        
        // 添加消息到界面
        function addMessageToUI(role, content) {
            const isUser = role === 'user';
            const isSystem = role === 'system';
            
            // 创建消息元素
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-4 message-appear opacity-0';
            
            // 设置头像和消息样式
            let avatar, messageBubble;
            
            if (isUser) {
                // 用户消息
                avatar = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-secondary flex items-center justify-center">
                        <i class="fa fa-user text-white"></i>
                    </div>
                `;
                messageBubble = `
                    <div class="max-w-[80%] ml-auto bg-primary text-white rounded-2xl rounded-tr-none p-4">
                        <p>${content}</p>
                    </div>
                `;
            } else if (isSystem) {
                // 系统消息
                avatar = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-500 flex items-center justify-center">
                        <i class="fa fa-exclamation-circle text-white"></i>
                    </div>
                `;
                messageBubble = `
                    <div class="max-w-[80%] bg-yellow-50 border border-yellow-200 rounded-2xl rounded-tl-none p-4">
                        <p class="text-yellow-800">${content}</p>
                    </div>
                `;
            } else {
                // AI消息
                avatar = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                        <img src="https://i.imgs.ovh/2025/08/04/YAAhA.png" alt="Socratic AI助手" class="w-full h-full object-contain">
                    </div>
                `;
                messageBubble = `
                    <div class="max-w-[80%] bg-neutral rounded-2xl rounded-tl-none p-4">
                        <p>${content}</p>
                    </div>
                `;
            }
            
            // 组合消息元素
            messageDiv.innerHTML = avatar + messageBubble;
            
            // 添加到聊天历史
            chatHistory.appendChild(messageDiv);
            
            // 滚动到底部
            scrollToBottom();
            
            // 触发动画
            setTimeout(() => {
                messageDiv.classList.remove('opacity-0');
            }, 50);
        }
        
        // 获取AI响应
        async function getAIResponse() {
            // 添加加载状态
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex items-start space-x-4 message-appear';
            loadingDiv.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                    <img src="https://i.imgs.ovh/2025/08/04/YAAhA.png" alt="Socratic AI助手" class="w-full h-full object-contain">
                </div>
                <div class="max-w-[80%] bg-neutral rounded-2xl rounded-tl-none p-4">
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
            chatHistory.appendChild(loadingDiv);
            scrollToBottom();
            
            try {
                // 调用Deepseek API
                const response = await fetch(API_CONFIG.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.model,
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });
                
                // 处理响应
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error?.message || `API请求失败 (状态码: ${response.status})`);
                }
                
                const data = await response.json();
                
                if (!data.choices || data.choices.length === 0 || !data.choices[0].message) {
                    throw new Error('未收到有效的响应内容');
                }
                
                const aiResponse = data.choices[0].message.content;
                
                // 移除加载状态
                document.getElementById('loading-indicator')?.remove();
                
                // 添加AI响应到界面
                addMessageToUI('assistant', aiResponse);
                
                // 添加AI响应到对话历史
                conversationHistory.push({
                    role: "assistant",
                    content: aiResponse
                });
                
                // 保存到用户对话历史
                userConversations[currentUser] = conversationHistory;
                saveConversations();
                
            } catch (error) {
                // 移除加载状态
                document.getElementById('loading-indicator')?.remove();
                throw error;
            }
        }
        
        // 滚动到聊天底部
        function scrollToBottom() {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    </script>
</body>
</html>
